<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Forgot Password - RentHub</title>
    <link rel="stylesheet" href="css/admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Reuse main styles but keep admin look consistent */
        .forgot-password-container { min-height:100vh; display:flex; align-items:center; justify-content:center; padding:2rem; background: linear-gradient(120deg, #6A0DAD 0%, #B57CE6 60%); }
        .forgot-password-box { background:white; padding:2rem; border-radius:10px; box-shadow:0 0 20px rgba(0,0,0,0.08); width:100%; max-width:420px; }
        .form-group{ margin-bottom:1.25rem; }
        .form-group label{ display:block; margin-bottom:.5rem; color:#333; }
        .form-group input{ width:100%; padding:.8rem; border:1px solid #ddd; border-radius:6px; }
        .btn{ width:100%; padding:0.9rem; background:#6A0DAD; color:white; border:none; border-radius:6px; cursor:pointer; }
        .otp-input{ display:flex; gap:.5rem; justify-content:center; margin:1rem 0 }
        .otp-input input{ width:50px; height:50px; text-align:center; font-size:1.1rem; border-radius:6px; }
        .message{ margin-top:1rem; display:none; }
    </style>
</head>
<body>
    <div class="forgot-password-container">
        <div class="forgot-password-box">
            <div style="display:flex; gap:12px; align-items:center; justify-content:center; margin-bottom:1rem;">
                <svg width="46" height="46" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="24" height="24" rx="6" fill="#fff"/><path d="M12 3v6" stroke="#6A0DAD" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M8 11v6a4 4 0 0 0 8 0v-6" stroke="#6A0DAD" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                <h2 style="text-align:center; margin:0; font-size:1.35rem; font-weight:700; color:#2c0535;">Admin Password Reset</h2>
            </div>
            <p style="text-align:center; color:#5e2f7a; margin-bottom:1.5rem;">Securely reset your admin password — we will send a one-time code to your registered admin email.</p>

            <div id="step1" class="step active">
                <p style="color:#444; text-align:center; margin-bottom:1rem; font-size:1.03rem">Enter the admin email address. We'll send a 6-digit OTP to your email to verify, then you can reset your password.</p>
                <form id="emailForm">
                    <div class="form-group">
                        <label for="email">Admin email</label>
                        <input id="email" type="email" placeholder="admin@yourdomain.com" required>
                    </div>
                    <button type="submit" class="btn">Send OTP</button>
                </form>
                <div id="resultMessage" style="display:none; margin-top:1rem; text-align:center"></div>
            </div>

            <div id="step2" class="step">
                <p style="color:#444; text-align:center; margin-bottom:1rem; font-size:1.03rem">Enter the 6-digit OTP sent to your admin email.</p>
                <form id="otpForm">
                    <div class="otp-input">
                        <input maxlength="1" class="otp-digit" data-index="0" required>
                        <input maxlength="1" class="otp-digit" data-index="1" required>
                        <input maxlength="1" class="otp-digit" data-index="2" required>
                        <input maxlength="1" class="otp-digit" data-index="3" required>
                        <input maxlength="1" class="otp-digit" data-index="4" required>
                        <input maxlength="1" class="otp-digit" data-index="5" required>
                    </div>
                    <button class="btn" type="submit">Verify OTP</button>
                    <div style="text-align:center; margin-top:.75rem"><button id="resendBtn" disabled style="background:none; border:none; color:#fff; cursor:pointer;">Resend OTP (<span id="countdown">60</span>s)</button></div>
                </form>
            </div>

            <div id="step3" class="step">
                <p style="color:#444; text-align:center; margin-bottom:1rem; font-size:1.03rem">Set your new admin password.</p>
                <form id="passwordForm">
                    <div class="form-group password-group">
                        <label for="newPassword">New Password</label>
                        <input id="newPassword" type="password" required minlength="8" placeholder="At least 8 characters">
                    </div>
                    <div class="form-group password-group">
                        <label for="confirmPassword">Confirm New Password</label>
                        <input id="confirmPassword" type="password" required minlength="8" placeholder="Repeat new password">
                    </div>
                    <button class="btn" type="submit">Reset Password</button>
                </form>
            </div>

            <div id="message" class="message"></div>
            <!-- toast container for nicer popups -->
            <div id="toastContainer" style="position:fixed; top:18px; right:18px; z-index:9999;"></div>

            <div style="text-align:center; margin-top:1rem"><a href="login.html">← Back to Admin Login</a></div>
        </div>
    </div>

    <script>
        // Admin OTP-based password reset client logic
        let adminEmail = '';
        let resendTimer = null;

        function isValidEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }

        function showResult(type, text) {
            // show inline message
            const el = document.getElementById('resultMessage');
            el.style.display = 'block';
            el.innerHTML = text;
            el.style.color = type === 'success' ? '#0a0' : '#900';
            el.style.background = type === 'success' ? 'rgba(255,255,255,0.04)' : 'rgba(255,255,255,0.05)';
            el.style.border = type === 'success' ? '1px solid rgba(0,255,0,0.08)' : '1px solid rgba(255,0,0,0.08)';
            el.style.padding = '12px';
            el.style.borderRadius = '8px';

            // toast popup
            const c = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.style.minWidth = '260px';
            toast.style.padding = '12px 16px';
            toast.style.borderRadius = '8px';
            toast.style.boxShadow = '0 6px 20px rgba(0,0,0,0.12)';
            toast.style.marginTop = '8px';
            toast.style.display = 'flex';
            toast.style.alignItems = 'center';
            toast.style.gap = '12px';
            toast.style.opacity = '0';
            toast.style.transition = 'opacity 240ms ease, transform 240ms ease';

            const icon = document.createElement('div');
            icon.innerHTML = type === 'success' ? '✅' : '⚠️';
            icon.style.fontSize = '18px';

            const msg = document.createElement('div');
            msg.innerHTML = text;
            msg.style.fontSize = '14px';
            msg.style.color = '#111';

            toast.appendChild(icon);
            toast.appendChild(msg);
            c.appendChild(toast);

            // animate in
            setTimeout(() => { toast.style.opacity = '1'; toast.style.transform = 'translateY(0)'; }, 20);

            // auto remove after 4 seconds
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => c.removeChild(toast), 300);
            }, 4000);
        }

        function clearResult() {
            const el = document.getElementById('resultMessage');
            el.style.display = 'none';
            el.innerHTML = '';
        }

        function switchTo(step) {
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            document.getElementById('step' + step).classList.add('active');
        }

        function startCountdown() {
            const btn = document.getElementById('resendBtn');
            const cd = document.getElementById('countdown');
            let timeLeft = 60;
            cd.textContent = timeLeft;
            btn.disabled = true;
            resendTimer = setInterval(() => {
                timeLeft -= 1;
                cd.textContent = timeLeft;
                if (timeLeft <= 0) {
                    clearInterval(resendTimer);
                    btn.disabled = false;
                    cd.textContent = '';
                }
            }, 1000);
        }

        document.getElementById('emailForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            clearResult();
            const email = document.getElementById('email').value.trim().toLowerCase();
            if (!email) return showResult('error', 'Please enter your admin email');
            if (!isValidEmail(email)) return showResult('error', 'Enter a valid email address');

            try {
                console.log('Attempting password reset for', adminEmail);
                const r = await fetch('/api/admin/forgot-password', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email })
                });
                const j = await r.json();
                if (r.ok) {
                    adminEmail = email;
                    showResult('success', j.message || 'OTP sent to admin email');
                    switchTo(2);
                    startCountdown();
                } else {
                    showResult('error', j.error || 'Failed to send OTP');
                }
            } catch (err) {
                console.error(err);
                showResult('error', 'Unexpected error, please try again later');
            }
        });

        // OTP inputs navigation
        document.querySelectorAll('.otp-digit').forEach(input => {
            input.addEventListener('input', function () {
                if (this.value.length === 1) {
                    const idx = Number(this.dataset.index);
                    if (idx < 5) document.querySelector(`[data-index="${idx + 1}"]`).focus();
                }
            });
            input.addEventListener('keydown', function (e) {
                if (e.key === 'Backspace' && this.value === '') {
                    const idx = Number(this.dataset.index);
                    if (idx > 0) document.querySelector(`[data-index="${idx - 1}"]`).focus();
                }
            });
        });

        let verifiedOtp = null; // store OTP after successful verification

        document.getElementById('otpForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            clearResult();
            const otp = Array.from(document.querySelectorAll('.otp-digit')).map(i => i.value).join('');
            if (otp.length !== 6) return showResult('error', 'Enter the 6-digit OTP');

            try {
                const r = await fetch('/api/reset-password', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email: adminEmail, otp })
                });
                const j = await r.json();
                if (r.ok) {
                    // store the otp so the password step can use it even if the inputs are changed
                    verifiedOtp = otp;
                    showResult('success', j.message || 'OTP verified — set your new password');
                    switchTo(3);
                } else {
                    showResult('error', j.error || 'Invalid or expired OTP');
                }
            } catch (err) {
                console.error(err);
                showResult('error', 'Unexpected error verifying OTP');
            }
        });

        document.getElementById('passwordForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            clearResult();
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            if (newPassword !== confirmPassword) return showResult('error', 'Passwords do not match');
            if (newPassword.length < 8) return showResult('error', 'Password must be at least 8 characters');

            // prefer the stored verified OTP; fall back to inputs
            const otpFromInputs = Array.from(document.querySelectorAll('.otp-digit')).map(i => i.value).join('');
            const otp = verifiedOtp || otpFromInputs;
            if (!otp || otp.length !== 6) return showResult('error', 'OTP missing - please verify OTP first');

            try {
                const r = await fetch('/api/reset-password', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email: adminEmail, otp, newPassword })
                });
                const j = await r.json();
                if (r.ok) {
                    showResult('success', j.message || 'Password reset successfully — redirecting to login...');
                    setTimeout(() => location.href = 'login.html', 1500);
                } else {
                    console.error('Password reset failed response:', j);
                    showResult('error', j.error || 'Failed to reset password');
                }
            } catch (err) {
                console.error(err);
                showResult('error', 'Unexpected error resetting password');
            }
        });

        document.getElementById('resendBtn').addEventListener('click', async () => {
            clearResult();
            if (!adminEmail) return showResult('error', 'No email captured — start from first step');
            try {
                const r = await fetch('/api/admin/forgot-password', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email: adminEmail }) });
                const j = await r.json();
                if (r.ok) {
                    showResult('success', j.message || 'OTP resent');
                    startCountdown();
                    document.querySelectorAll('.otp-digit').forEach(i => i.value = '');
                } else {
                    showResult('error', j.error || 'Failed to resend OTP');
                }
            } catch (err) {
                console.error(err);
                showResult('error', 'Unexpected error, try again');
            }
        });
    </script>
</body>
</html>
